#!/bin/bash

# $1 : Dialog title
# $2 : 0 : Sender mode ; 1 : Receive mode

fs=""
size=""
usedspace=""
elapsed="00:00:00"
remaining="00:00:00"
percent=0
bitrate=0
total_clients=0

# Strip comma and percent
stripcomma="sed s/[,%]//g"

cat /dev/stdin| _r_to_n |while read line; do
  [ -z "$line" ] && continue
  echo $line|grep 'File system'>/dev/null && fs=$(echo $line|sed 's/File system://'  | sed -e 's/^ *//' -e 's/ *$//')
  echo $line|grep 'Device size'>/dev/null && size=$(echo $line|sed 's/Device size://'  | sed -e 's/^ *//' -e 's/ *$//')
  echo $line|grep 'Space in use'>/dev/null && usedspace=$(echo $line|sed 's/Space in use://'  | sed -e 's/^ *//' -e 's/ *$//')
  
  if echo $line|grep 'Completed:'>/dev/null; then
    elapsed=$(echo $line|awk '{ print $2 }'| $stripcomma )
    remaining=$(echo $line|awk '{ print $4 }'| $stripcomma )
    percent=$(echo $line|awk '{ print $6 }'| $stripcomma )
    # decimal point not supoprted by dialog
    percent=$(echo $percent|tr '.' ' '|awk '{print $1}')
    bitrate=$(echo $line|awk '{ print $7 }'| $stripcomma )
  fi

  if [ $2 -eq "0" ]; then
      # Sending mode
      connections=$(grep 'New connection' /tmp/udp_output|wc -l)
      diconnections=$(grep 'Disconnecting' /tmp/udp_output|wc -l)
      total_clients=$(expr $connections - $diconnections)

      if grep 'Starting transfer' /tmp/udp_output; then
          # Show current progress
          cat <<EOF
XXX
$percent
 
Restauration multicast vers $total_clients clients
Système de fichier: $fs
Espace utilisé: $usedspace

Temps écoulé: $elapsed
Temps restant: $remaining

Débit: $bitrate
XXX
EOF
      else
         cat <<EOF
XXX
0
 
Attente des clients
Clients connectés: $total_clients
XXX
EOF

      fi
         
  else
      # Receiver mode

      if grep 'Connected' /tmp/udp_output; then
      # Show current progress

      if [ "$bitrate" = "0" ]; then
          status="Connecté. Attente du serveur."
      else
          status="Réception des données..."
      fi

cat <<EOF
XXX
$percent
 
$status
Système de fichier: $fs
Espace utilisé: $usedspace

Temps écoulé: $elapsed
Temps restant: $remaining

Débit: $bitrate
XXX
EOF

      else
          # Disconnected

cat <<EOF
XXX
0

Pas de session Multicast détectée, attente.
XXX
EOF



      fi

      
  fi


done |
dialog --backtitle "Pulse imaging client" --title "Mandriva Pulse: $1" --gauge "Please wait" 15 70 0
exit 0
