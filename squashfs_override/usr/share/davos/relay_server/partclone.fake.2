#!/bin/bash

# ==========================================================
# Get original partclone binary 
# ==========================================================

# If caller is symlink, orig is target.orig
bin=$0
test -L $0 && bin=/usr/sbin/$(readlink $0)  

# Dialog get ouptut (redirection to have dialog output on stdout)
toStdOut='3>&2 2>&1 1>&3-'

# Reading udp_options
udp_options=$(cat /tmp/udp_options)

# Increment the partclone_index
restore_index=$(expr 1 + `cat /tmp/partclone_index`)
echo $restore_index > /tmp/partclone_index

# ==========================================================
# Alert user that multicast will start
# ==========================================================

multicast_group=$(grep 'davos_multicast_group=' /proc/cmdline | sed 's|.*davos_multicast_group=\([^ ]*\).*|\1|')
[ -z "$multicast_group" ] && multicast_group='0'

ip_prefix="239.255".$multicast_group
ttl=4

cmp_tool=$(grep 'davos_cmp_tool=' /proc/cmdline | sed 's|.*davos_cmp_tool=\([^ ]*\).*|\1|')
[ -z "$cmp_tool" ] && cmp_tool='pigz'


{ $bin.orig $@ 2>&3 |$cmp_tool -c --fast | udp-sender --ttl $ttl $udp_options --mcast-rdv-address $ip_prefix.$restore_index --mcast-data-address $ip_prefix.200 2>/tmp/udp_output; } 3>&1 1>&2 | partclone_wrapper "Imaging Relay Server" 0
